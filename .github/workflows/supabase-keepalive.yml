name: Supabase Keep-Alive

# 每日 UTC 00:00 執行（台灣時間早上 8:00）
# 防止 Supabase Free Plan 7 天閒置自動暫停
on:
  schedule:
    # 每日 UTC 00:00 (台灣時間 08:00)
    - cron: '0 0 * * *'

  # 允許手動觸發
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase Edge Function
        run: |
          echo "Pinging Supabase to prevent idle suspension..."

          # Ping Supabase (any HTTP response = project is active, prevents idle)
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://dofgtiavdperiqxkvrla.supabase.co/functions/v1/free-rate-limit" \
            --max-time 30)

          echo "HTTP Status: $http_code"

          # Any HTTP response means the project is active (even 4xx)
          if [ "$http_code" -gt 0 ] 2>/dev/null; then
            echo "✅ Ping successful! Supabase responded with $http_code - project is active."
            exit 0
          else
            echo "❌ Ping failed - no response from Supabase"
            exit 1
          fi

      - name: Log execution time
        if: always()
        run: |
          echo "Execution completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
