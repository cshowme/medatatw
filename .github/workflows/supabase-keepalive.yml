name: Supabase Keep-Alive

# 每日 UTC 00:00 執行（台灣時間早上 8:00）
# 防止 Supabase Free Plan 7 天閒置自動暫停
on:
  schedule:
    # 每日 UTC 00:00 (台灣時間 08:00)
    - cron: '0 0 * * *'

  # 允許手動觸發
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase Edge Function
        run: |
          echo "Pinging Supabase to prevent idle suspension..."

          # 發送 GET 請求到 free-rate-limit endpoint
          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            "https://dofgtiavdperiqxkvrla.supabase.co/functions/v1/free-rate-limit")

          # 分離 body 和 status code
          http_body=$(echo "$response" | head -n -1)
          http_code=$(echo "$response" | tail -n 1)

          echo "HTTP Status: $http_code"
          echo "Response Body: $http_body"

          # 檢查是否成功（2xx status code）
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "✅ Ping successful! Supabase is active."
            exit 0
          else
            echo "❌ Ping failed with status $http_code"
            exit 1
          fi

      - name: Log execution time
        if: always()
        run: |
          echo "Execution completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
